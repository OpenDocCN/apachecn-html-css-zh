# 附录 2。浏览器代表对 CSS 性能的看法

作为[附录 1](10.html "Appendix 1. CSS Selector Performance") 、 *CSS 选择器性能*的附录，以下文本涉及浏览器代表对 CSS 性能的看法。

# TL；速度三角形定位法(dead reckoning)

如果你没有读到这一部分，读下一段，把它记在心里:

不要在没有检查自己的*数据*的情况下，就记忆与 CSS 性能相关的规则。它们在很大程度上是无用的、短暂的和过于主观的。相反，要熟悉工具，并使用它们来揭示您自己场景的相关数据。这基本上是 Chrome Developer relations 多年来一直在推广的口头禅，我相信是 Paul Lewis(以下将详细介绍)创造了与网络性能故障排除相关的术语*工具，而不是规则*。

如今我明白了这一点。真的明白了。

# 浏览器代表对 CSS 性能的评价

虽然我在创作样式表时通常从不担心 CSS 选择器(通常我只是在任何我想设计的样式上放一个类，然后直接选择它)，但我经常看到比我聪明的人的评论，这些评论专门与某个选择器相关。以下是保罗·爱尔兰的一段话(T2)https://www.paulirish.com/的一篇文章(除了海登·皮克林的文章之外，T4 的文章)使用了一种特殊的选择器:

> *这些选择器是最慢的。~比 div.box 这样的百搭款慢 500:不是(:空):最后一个类型。标题”。测试页面 http://jsbin.com/gozula/1/quiet 也就是说，选择器的速度很少受到关注，但是如果这个选择器最终出现在一个动态的网络应用程序中，其中 DOM 的变化非常常见，它可能会有很大的影响。因此，对许多用例来说是好的，但请记住，随着应用程序的成熟，这可能会成为性能瓶颈。在这一点上需要注意。干杯*

我们能从中得到什么？我们是否试图在一些*中持有那种在紧急情况下不使用的选择器*在我们的头脑中跳马？

为了得到一些真实的答案，我问了那些真正在浏览器上工作的聪明人，他们认为我们应该关注 CSS 的性能。

在前端领域，我们很幸运，Chrome 开发者关系团队非常容易接近。然而，我喜欢平衡。此外，我接触了微软和火狐的人，并从网络工具包中获得了一些很好的信息。

# 我们应该担心 CSS 选择器吗？

问题本质上是，*作者是否应该关注与 CSS 性能相关的选择器？*

让我们从开头开始，像 CSSOM 和 DOM 这样的东西实际上是在这里构建的。Chrome 开发者关系的开发者倡导者保罗·刘易斯(Paul Lewis)([http://aerotwist.com/](http://aerotwist.com/))解释说，*风格计算受到两件事的影响:选择器匹配和无效的大小。当你第一次加载一个页面时，需要计算所有元素的所有样式，这是树大小和选择器数量的函数。*

更多细节，Lewis 引用了 Opera 团队的*Rune Lillesveen*([https://docs . Google . com/document/d/1 vew 86 daevs 4 uqznfi5r-_ xs9 TCS 1cs _ eushrsgchgu 8/edit #](https://docs.google.com/document/d/1vEW86DaeVs4uQzNFI5R-_xS9TcS1Cs_EUsHRSgCHGu8/edit#))(他在 Blink 的风格代码上做了很多工作):

> *在编写本文时，用于计算元素的计算样式的大约 50%的时间用于匹配选择器，另一半时间用于根据匹配的规则构建 RenderStyle(计算样式表示)。*

好吧，对我来说，这有点像科学，那么这是否意味着我们需要担心选择者？

Lewis 再次强调，*选择器匹配会影响性能，但根据我的经验，树的大小往往是最重要的因素*。

显而易见，如果你有一个巨大的 DOM 树，和一大堆不相关的风格，事情就会开始突突的发展。我自己的*腹胀测试*([https://benfrain.com/selector-test/2-01.html](https://benfrain.com/selector-test/2-01.html))支持这一点。换个角度考虑。如果我给你两堆 1000 张牌，除了 5 张匹配的牌之外，每一张牌都有不同的名字，那么与只有 100 张或 10 张牌的情况相比，匹配这些匹配的名字需要更长的时间。浏览器的主体相同。

我想我们都同意风格膨胀是比使用的 CSS 选择器更大的问题。也许这是我们可以信赖的一条规则？

|   | *对于大多数网站，我认为选择器性能并不是你花时间寻找性能优化的最佳领域。我强烈建议关注牙套内部的东西，而不是牙套外部的选择器* |   |
|   | - *格雷格·惠特沃思，微软*项目经理 |

# 【JavaScript 呢

然而，惠特沃思也指出，在处理 JavaScript 和 DOM 结构中的动态性时，需要额外的努力，*如果你在一次又一次地使用 JavaScript 添加或替换事件类，你应该考虑这会如何影响整个 web 管道和你正在接触的盒子的 DOM 结构*。

这与保罗·爱尔兰早先的评论相吻合。由于类的改变，DOM 区域的快速失效偶尔会出现复杂的选择器。所以，也许我们应该担心选择者？

|   | *每个规则都有例外，也有比其他规则性能更高的选择器，但我们通常只在大量 DOM 树与 JavaScript 反模式协同工作，导致 DOM 抖动和额外布局或绘制发生的情况下看到这些* |   |
|   | 惠特沃思 |

对于更简单的 JavaScript 更改，刘易斯给出了这样的建议，*解决方案通常是尽可能接近目标元素，尽管 Blink 越来越聪明地知道哪些元素将真正受到父元素更改的影响*。因此，实际上，如果您需要影响 DOM 元素的更改，如果可能的话，在 DOM 树中直接在它上面添加一个类，而不是在主体或 html 节点上。

# 处理 CSS 性能

在这一点上，我很高兴地重新总结在[附录 1](10.html "Appendix 1. CSS Selector Performance") 、 *CSS 选择器性能*中得出的结论——CSS 选择器很少是静态页面的问题。此外，试图猜测哪个选择器性能好可能是徒劳的。

然而，对于大型 DOM 和动态 DOM(例如，不是奇怪的类切换，我们说的是大量的 JavaScript 操作)来说，CSS 选择器可能会导致一个问题。*我不能代表所有的 Mozilla，但我认为当你在处理性能时，你应该关注什么是慢的。有时那将是选择者；通常会是其他事情*，来自*Mozilla*([https://www.mozilla.org/en-US/](https://www.mozilla.org/en-US/))的 *L .大卫·巴伦*([http://dbaron.org/](http://dbaron.org/))和 W3C CSS 工作组的成员。*我肯定见过选择器性能很重要的页面，也肯定见过很多选择器性能不重要的页面*。

那我们该怎么办？最务实的做法是什么？

|   | *您应该使用分析工具来确定您的性能问题在哪里，然后努力解决这些问题* |   |
|   | - *男爵* |

我与之交谈的每个人都赞同这些观点。

# 总结

如果你已经在网络上发展了一段时间，你会知道大多数网络相关问题的答案是*这取决于*。我讨厌在任何情况下都没有简单的、铁一般的 CSS 性能规则。我真的很想把这些规则写在一个漂亮的小段落里，并且相信它们会普遍适用。但我不能，因为根本没有任何与性能相关的通用*铸铁*真理。不可能有，因为变量太多了。引擎更新，布局方法优化，每个 DOM 树都不一样，所有 CSS 文件都不一样。没完没了。你明白了。

恐怕我能提供的最好的办法就是不要提前为 CSS 选择器或者布局方法之类的事情伤脑筋。他们不太可能成为你的问题(但是，你知道，他们可能会)。相反，集中精力把*做成*这个东西。然后，当*的东西*被制造出来的时候，测试*的东西*。如果慢了或者坏了，找到问题，把*的东西*修好。

## 附加信息

*   格雷格·惠特沃思推荐 2012 年构建演讲([http://blogs . msdn . com/b/ie/archive/2012/11/20/Build-2012-50-性能技巧-让你的 html 5-应用程序和网站更快](http://blogs.msdn.com/b/ie/archive/2012/11/20/build-2012-50-performance-tricks-to-make-your-html5-applications-and-sites-faster.aspx)
*   保罗·路易斯的 *CSS 触发器*([https://csstriggers.com/](https://csstriggers.com/))指出了 CSS 中的哪些变化会触发闪烁引擎(Chrome/Opera)中的布局、绘制和合成操作